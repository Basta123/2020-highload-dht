
Для нагрузочного тестирования сервера, а также измерения параметров была использована программа wrk, а также профайлер под названием async-profiler. 
Запросы были сделаны на локальный хост по адресу http://127.0.0.1:8080.

Выполним запрос, используя следующую команду: wrk -t1 -c1 -d10m -s wrk/put.lua -R2000 --latency http://127.0.0.1:8080. Для формирования запроса мы используем скрипт на языке Lua.


Running 10m test @ http://127.0.0.1:8080
  1 threads and 1 connections
  Thread calibration: mean lat.: 8.657ms, rate sampling interval: 11ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     2.89ms    3.55ms  68.03ms   92.50%
    Req/Sec     2.14k   640.02    12.90k    79.91%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    2.02ms
 75.000%    3.26ms
 90.000%    5.54ms
 99.000%   18.70ms
 99.900%   39.26ms
 99.990%   58.85ms
 99.999%   66.05ms
100.000%   68.10ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.045     0.000000            1         1.00
       0.606     0.100000       118266         1.11
       1.008     0.200000       236064         1.25
       1.345     0.300000       354223         1.43
       1.668     0.400000       472043         1.67
       2.017     0.500000       590196         2.00
       2.211     0.550000       649336         2.22
       2.421     0.600000       708016         2.50
       2.657     0.650000       767247         2.86
       2.921     0.700000       826082         3.33
       3.255     0.750000       885307         4.00
       3.463     0.775000       914595         4.44
       3.715     0.800000       944021         5.00
       4.029     0.825000       973572         5.71
       4.419     0.850000      1003019         6.67
       4.907     0.875000      1032618         8.00
       5.203     0.887500      1047411         8.89
       5.543     0.900000      1062017        10.00
       5.947     0.912500      1076777        11.43
       6.439     0.925000      1091511        13.33
       7.059     0.937500      1106304        16.00
       7.443     0.943750      1113656        17.78
       7.907     0.950000      1121018        20.00
       8.487     0.956250      1128392        22.86
       9.223     0.962500      1135771        26.67
      10.215     0.968750      1143149        32.00
      10.831     0.971875      1146808        35.56
      11.575     0.975000      1150515        40.00
      12.471     0.978125      1154188        45.71
      13.639     0.981250      1157879        53.33
      15.079     0.984375      1161563        64.00
      15.927     0.985938      1163412        71.11
      16.879     0.987500      1165258        80.00
      17.951     0.989062      1167098        91.43
      19.231     0.990625      1168931       106.67
      20.767     0.992188      1170780       128.00
      21.615     0.992969      1171698       142.22
      22.607     0.993750      1172622       160.00
      23.759     0.994531      1173545       182.86
      25.087     0.995313      1174472       213.33
      26.767     0.996094      1175385       256.00
      27.759     0.996484      1175848       284.44
      28.863     0.996875      1176307       320.00
      30.207     0.997266      1176771       365.71
      31.695     0.997656      1177231       426.67
      33.471     0.998047      1177695       512.00
      34.399     0.998242      1177922       568.89
      35.423     0.998437      1178150       640.00
      36.671     0.998633      1178383       731.43
      37.951     0.998828      1178610       853.33
      39.487     0.999023      1178842      1024.00
      40.383     0.999121      1178959      1137.78
      41.247     0.999219      1179072      1280.00
      42.271     0.999316      1179186      1462.86
      43.615     0.999414      1179304      1706.67
      45.247     0.999512      1179417      2048.00
      46.175     0.999561      1179474      2275.56
      47.199     0.999609      1179532      2560.00
      48.351     0.999658      1179590      2925.71
      49.759     0.999707      1179647      3413.33
      51.359     0.999756      1179706      4096.00
      52.319     0.999780      1179733      4551.11
      53.503     0.999805      1179762      5120.00
      54.559     0.999829      1179791      5851.43
      55.999     0.999854      1179820      6826.67
      57.503     0.999878      1179848      8192.00
      58.271     0.999890      1179863      9102.22
      59.007     0.999902      1179877     10240.00
      59.679     0.999915      1179892     11702.86
      60.447     0.999927      1179907     13653.33
      61.247     0.999939      1179920     16384.00
      61.759     0.999945      1179928     18204.44
      62.303     0.999951      1179935     20480.00
      62.847     0.999957      1179942     23405.71
      63.391     0.999963      1179949     27306.67
      63.967     0.999969      1179956     32768.00
      64.351     0.999973      1179960     36408.89
      64.703     0.999976      1179964     40960.00
      64.959     0.999979      1179967     46811.43
      65.215     0.999982      1179971     54613.33
      65.471     0.999985      1179974     65536.00
      65.663     0.999986      1179976     72817.78
      65.855     0.999988      1179978     81920.00
      66.047     0.999989      1179980     93622.86
      66.367     0.999991      1179983    109226.67
      66.367     0.999992      1179983    131072.00
      66.623     0.999993      1179984    145635.56
      66.687     0.999994      1179985    163840.00
      66.815     0.999995      1179986    187245.71
      66.943     0.999995      1179987    218453.33
      67.199     0.999996      1179988    262144.00
      67.199     0.999997      1179988    291271.11
      67.455     0.999997      1179989    327680.00
      67.455     0.999997      1179989    374491.43
      67.711     0.999998      1179990    436906.67
      67.711     0.999998      1179990    524288.00
      67.711     0.999998      1179990    582542.22
      67.903     0.999998      1179991    655360.00
      67.903     0.999999      1179991    748982.86
      67.903     0.999999      1179991    873813.33
      67.903     0.999999      1179991   1048576.00
      67.903     0.999999      1179991   1165084.44
      68.095     0.999999      1179992   1310720.00
      68.095     1.000000      1179992          inf



1199997 requests in 10.00m, 106.43MB read
Requests/sec:   1999.99
Transfer/sec:    181.64KB





Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    2.02ms
 75.000%    3.26ms
 90.000%    5.54ms
 99.000%   18.70ms
 99.900%   39.26ms
 99.990%   58.85ms
 99.999%   66.05ms
100.000%   68.10ms

Как видно 1% запросов занимает существенно больше времени, чем все остальные запросы, что может быть связано с записью данных из памяти на жесткий диск после пересечения порога.


![](https://github.com/Basta123/2020-highload-dht/blob/master/profiling/CPUPut.svg)

Видно, что вся нагрузка идет на SelectorThread, 32,33% уходит на отправку ответа (HttpSession.sendResponse), а на операцию putValueByKey 36,09%.



![](https://github.com/Basta123/2020-highload-dht/blob/master/profiling/AllocPut.svg)


Основываясь на результатах мы можем сделать выводы о том что  100% занимает SelectorThread, 35.3% уходит на операцию put (MyHttpServiceImpl.put).


Проведем тестирование get запросов.
Для этого в командной строке используем команду wrk -t1 -c1 -d3m -s wrk/get.lua -R2000 —latency http://127.0.0.1:8080


wrk -t1 -c1 -d3m -s wrk/get.lua -R2000 --latency http://127.0.0.1:8080
Running 3m test @ http://127.0.0.1:8080
  1 threads and 1 connections
  Thread calibration: mean lat.: 7.840ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     3.23ms    6.61ms 143.10ms   95.76%
    Req/Sec     2.16k   667.64     9.44k    80.14%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.87ms
 75.000%    3.10ms
 90.000%    5.46ms
 99.000%   30.78ms
 99.900%   88.13ms
 99.990%  136.06ms
 99.999%  142.98ms
100.000%  143.23ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.072     0.000000            1         1.00
       0.603     0.100000        34050         1.11
       0.949     0.200000        68101         1.25
       1.260     0.300000       102044         1.43
       1.555     0.400000       136013         1.67
       1.873     0.500000       170003         2.00
       2.053     0.550000       187127         2.22
       2.259     0.600000       204028         2.50
       2.493     0.650000       221016         2.86
       2.765     0.700000       238043         3.33
       3.097     0.750000       255051         4.00
       3.301     0.775000       263503         4.44
       3.545     0.800000       272016         5.00
       3.851     0.825000       280525         5.71
       4.243     0.850000       289038         6.67
       4.755     0.875000       297537         8.00
       5.075     0.887500       301739         8.89
       5.463     0.900000       306021        10.00
       5.939     0.912500       310239        11.43
       6.555     0.925000       314505        13.33
       7.391     0.937500       318741        16.00
       7.959     0.943750       320870        17.78
       8.679     0.950000       323006        20.00
       9.607     0.956250       325119        22.86
      10.871     0.962500       327241        26.67
      12.695     0.968750       329365        32.00
      13.831     0.971875       330423        35.56
      15.247     0.975000       331489        40.00
      16.991     0.978125       332559        45.71
      19.135     0.981250       333614        53.33
      21.999     0.984375       334676        64.00
      23.759     0.985938       335204        71.11
      25.983     0.987500       335740        80.00
      28.719     0.989062       336270        91.43
      32.447     0.990625       336797       106.67
      36.671     0.992188       337329       128.00
      39.807     0.992969       337596       142.22
      42.975     0.993750       337861       160.00
      46.463     0.994531       338125       182.86
      50.975     0.995313       338391       213.33
      56.959     0.996094       338657       256.00
      59.743     0.996484       338789       284.44
      62.239     0.996875       338922       320.00
      64.639     0.997266       339055       365.71
      67.327     0.997656       339191       426.67
      70.463     0.998047       339322       512.00
      72.959     0.998242       339387       568.89
      76.287     0.998437       339453       640.00
      79.807     0.998633       339520       731.43
      83.391     0.998828       339587       853.33
      89.087     0.999023       339652      1024.00
      92.351     0.999121       339686      1137.78
      96.063     0.999219       339719      1280.00
     100.031     0.999316       339752      1462.86
     104.959     0.999414       339785      1706.67
     110.911     0.999512       339818      2048.00
     113.407     0.999561       339835      2275.56
     116.223     0.999609       339852      2560.00
     118.719     0.999658       339868      2925.71
     121.535     0.999707       339885      3413.33
     124.351     0.999756       339901      4096.00
     126.079     0.999780       339911      4551.11
     127.231     0.999805       339918      5120.00
     129.663     0.999829       339926      5851.43
     132.479     0.999854       339935      6826.67
     134.271     0.999878       339943      8192.00
     135.295     0.999890       339947      9102.22
     136.319     0.999902       339951     10240.00
     137.343     0.999915       339955     11702.86
     138.623     0.999927       339960     13653.33
     139.647     0.999939       339964     16384.00
     140.159     0.999945       339966     18204.44
     140.671     0.999951       339968     20480.00
     141.055     0.999957       339970     23405.71
     141.439     0.999963       339972     27306.67
     141.823     0.999969       339974     32768.00
     141.951     0.999973       339975     36408.89
     142.207     0.999976       339976     40960.00
     142.463     0.999979       339977     46811.43
     142.719     0.999982       339979     54613.33
     142.719     0.999985       339979     65536.00
     142.975     0.999986       339982     72817.78
     142.975     0.999988       339982     81920.00
     142.975     0.999989       339982     93622.86
     142.975     0.999991       339982    109226.67
     142.975     0.999992       339982    131072.00
     142.975     0.999993       339982    145635.56
     142.975     0.999994       339982    163840.00
     143.103     0.999995       339983    187245.71
     143.103     0.999995       339983    218453.33
     143.103     0.999996       339983    262144.00
     143.103     0.999997       339983    291271.11
     143.103     0.999997       339983    327680.00
     143.231     0.999997       339984    374491.43
     143.231     1.000000       339984          inf
#[Mean    =        3.234, StdDeviation   =        6.610]
#[Max     =      143.104, Total count    =       339984]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  359995 requests in 3.00m, 34.22MB read
Requests/sec:   1999.95
Transfer/sec:    194.65KB

Около 1% запросов имеют существенно большее время отклика, чем остальные 99%.

CPU Get

![](https://github.com/Basta123/2020-highload-dht/blob/master/profiling/CPUGet.svg)


Alloc Get

![](https://github.com/Basta123/2020-highload-dht/blob/master/profiling/AllocGet.svg)

Мы можем сделать вывод о том что 100%  занимает SelectorThread, также
73% уходита на Dao.get



